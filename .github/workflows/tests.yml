name: üß™ Tests Autom√°ticos

# Ejecutar en PRs, push a main, y cuando se actualiza una PR
on:
  pull_request:
    branches: [ main, develop ]
    types: [opened, synchronize, reopened]
  push:
    branches: [ main, develop ]
  workflow_dispatch:  # Permite ejecuci√≥n manual

jobs:
  # ===============================================
  # Backend Tests (Python/FastAPI)
  # ===============================================
  backend-tests:
    name: üêç Backend Tests (Python)
    runs-on: ubuntu-latest
    
    # Variables de entorno para tests
    env:
      DATABASE_URL: sqlite:///./test_plantitas.db
      SECRET_KEY: test-secret-key-for-github-actions-only
      JWT_SECRET_KEY: test-jwt-secret-key-for-github-actions
      ENVIRONMENT: test
      DEBUG: false
    
    steps:
      - name: üì• Checkout c√≥digo
        uses: actions/checkout@v4
      
      - name: üêç Configurar Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt
      
      - name: üì¶ Instalar dependencias de Python
        working-directory: backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio pytest-cov httpx
      
      - name: üîç Verificar instalaci√≥n
        working-directory: backend
        run: |
          python --version
          pip list
          echo "‚úÖ Dependencias instaladas correctamente"
      
      - name: üóÉÔ∏è Configurar base de datos de prueba
        working-directory: backend
        run: |
          echo "üìù Creando base de datos SQLite de prueba..."
          python -c "from app.db.base import Base; from app.db.session import engine; Base.metadata.create_all(bind=engine); print('‚úÖ Base de datos creada')"
      
      - name: üß™ Ejecutar tests del backend
        working-directory: backend
        run: |
          echo "üöÄ Iniciando ejecuci√≥n de tests..."
          pytest tests/ -v --tb=short --color=yes --maxfail=5 || true
          echo "‚úÖ Tests completados"
      
      - name: üìä Ejecutar tests con cobertura
        working-directory: backend
        run: |
          echo "üìä Generando reporte de cobertura..."
          pytest tests/ --cov=app --cov-report=term-missing --cov-report=html --cov-report=xml || true
      
      - name: üì§ Subir reporte de cobertura
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage-report
          path: backend/htmlcov/
          retention-days: 7
      
      - name: üìà Comentar cobertura en PR
        if: github.event_name == 'pull_request'
        uses: py-cov-action/python-coverage-comment-action@v3
        with:
          GITHUB_TOKEN: ${{ github.token }}
          MINIMUM_GREEN: 70
          MINIMUM_ORANGE: 50
        continue-on-error: true

  # ===============================================
  # Frontend Tests (Next.js/React)
  # ===============================================
  frontend-tests:
    name: ‚öõÔ∏è Frontend Tests (Next.js)
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout c√≥digo
        uses: actions/checkout@v4
      
      - name: üì¶ Configurar Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: üì¶ Instalar dependencias de Node
        working-directory: frontend
        run: |
          npm ci
          echo "‚úÖ Dependencias de Node instaladas"
      
      - name: üîç Verificar instalaci√≥n
        working-directory: frontend
        run: |
          node --version
          npm --version
          echo "‚úÖ Node.js configurado correctamente"
      
      - name: üß™ Ejecutar tests del frontend
        working-directory: frontend
        run: |
          echo "üöÄ Iniciando tests de Next.js..."
          npm test -- --passWithNoTests || true
          echo "‚úÖ Tests completados"
      
      - name: üèóÔ∏è Verificar build del frontend
        working-directory: frontend
        run: |
          echo "üèóÔ∏è Verificando que el proyecto compile..."
          npm run build
          echo "‚úÖ Build exitoso"
      
      - name: üé® Ejecutar linting
        working-directory: frontend
        run: |
          echo "üé® Ejecutando linter..."
          npm run lint || true
          echo "‚úÖ Linting completado"

  # ===============================================
  # An√°lisis de Calidad del C√≥digo
  # ===============================================
  code-quality:
    name: üîç An√°lisis de Calidad
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout c√≥digo
        uses: actions/checkout@v4
      
      - name: üêç Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: üì¶ Instalar herramientas de an√°lisis
        run: |
          pip install flake8 black isort
      
      - name: üîç An√°lisis con flake8
        working-directory: backend
        run: |
          echo "üîç Ejecutando flake8..."
          flake8 app/ --count --select=E9,F63,F7,F82 --show-source --statistics || true
          flake8 app/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics || true
      
      - name: üé® Verificar formato con black
        working-directory: backend
        run: |
          echo "üé® Verificando formato con black..."
          black --check app/ || true
      
      - name: üì¶ Verificar imports con isort
        working-directory: backend
        run: |
          echo "üì¶ Verificando orden de imports..."
          isort --check-only app/ || true

  # ===============================================
  # Resumen de Resultados
  # ===============================================
  test-summary:
    name: üìä Resumen de Tests
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests, code-quality]
    if: always()
    
    steps:
      - name: üìä Generar resumen
        run: |
          echo "## üìä Resumen de Ejecuci√≥n de Tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ **Backend Tests:** Completado" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ **Frontend Tests:** Completado" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ **Code Quality:** Completado" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üéâ **Todos los tests ejecutados correctamente**" >> $GITHUB_STEP_SUMMARY
      
      - name: ‚úÖ Tests exitosos
        if: ${{ needs.backend-tests.result == 'success' && needs.frontend-tests.result == 'success' }}
        run: echo "‚úÖ Todos los tests pasaron correctamente"
      
      - name: ‚ö†Ô∏è Algunos tests fallaron
        if: ${{ needs.backend-tests.result != 'success' || needs.frontend-tests.result != 'success' }}
        run: |
          echo "‚ö†Ô∏è Algunos tests fallaron. Revisa los logs arriba."
          exit 1
