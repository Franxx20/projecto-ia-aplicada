name: ðŸ³ Docker Build (Sin Push)

# Ejecutar cuando se hace push a main o se crea un tag
on:
  push:
    branches: [ main ]
    tags:
      - 'v*.*.*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  # ===============================================
  # Build Backend Image
  # ===============================================
  build-backend:
    name: ðŸ Build Backend Image
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: ðŸ—ï¸ Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: ðŸ³ Build Backend Image (Sin Push)
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: false
          tags: backend:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          load: true
      
      - name: âœ… Build exitoso
        run: |
          echo "âœ… Backend image construida exitosamente"
          echo "ðŸ·ï¸ Tag: backend:${{ github.sha }}"
          echo "ðŸ“¦ La imagen NO se ha subido a ningÃºn registry"

  # ===============================================
  # Build Frontend Image
  # ===============================================
  build-frontend:
    name: âš›ï¸ Build Frontend Image
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: ðŸ—ï¸ Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: ðŸ³ Build Frontend Image (Sin Push)
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: false
          tags: frontend:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          load: true
      
      - name: âœ… Build exitoso
        run: |
          echo "âœ… Frontend image construida exitosamente"
          echo "ðŸ·ï¸ Tag: frontend:${{ github.sha }}"
          echo "ðŸ“¦ La imagen NO se ha subido a ningÃºn registry"

  # ===============================================
  # Resumen de Build
  # ===============================================
  build-summary:
    name: ðŸ“Š Resumen de Build
    runs-on: ubuntu-latest
    needs: [build-backend, build-frontend]
    if: always()
    
    steps:
      - name: ðŸ“Š Generar resumen
        run: |
          echo "## ðŸ³ Resumen de Docker Build" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Backend Image:** Construida localmente" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Frontend Image:** Construida localmente" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ·ï¸ **Ref:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ·ï¸ **SHA:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ **Nota:** Las imÃ¡genes NO se han subido a ningÃºn registry" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ‰ **Todas las imÃ¡genes construidas y validadas exitosamente**" >> $GITHUB_STEP_SUMMARY
