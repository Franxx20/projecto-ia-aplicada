name: ðŸŽ¨ Code Quality & Linting

# Ejecutar en PRs y push a ramas principales
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  # ===============================================
  # Python Code Quality
  # ===============================================
  python-quality:
    name: ðŸ Python Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: ðŸ Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ðŸ“¦ Instalar herramientas
        run: |
          pip install flake8 black isort mypy pylint autopep8
      
      - name: ðŸ” Flake8 - AnÃ¡lisis de estilo
        working-directory: backend
        run: |
          echo "ðŸ” Ejecutando Flake8..."
          flake8 app/ --count --statistics --show-source \
            --max-line-length=127 \
            --extend-ignore=E203,W503 \
            --exclude=__pycache__,.git,__init__.py \
            --format='%(path)s:%(row)d:%(col)d: %(code)s %(text)s' \
            > flake8-report.txt || true
          cat flake8-report.txt
          echo "âœ… Flake8 completado"
      
      - name: ðŸŽ¨ Black - Verificar formato
        working-directory: backend
        run: |
          echo "ðŸŽ¨ Verificando formato con Black..."
          black --check --diff app/ || echo "âš ï¸ Algunos archivos necesitan formato"
      
      - name: ðŸ“¦ isort - Verificar imports
        working-directory: backend
        run: |
          echo "ðŸ“¦ Verificando orden de imports con isort..."
          isort --check-only --diff app/ || echo "âš ï¸ Algunos imports necesitan ordenarse"
      
      - name: ðŸ”¬ MyPy - Type checking
        working-directory: backend
        run: |
          echo "ðŸ”¬ Ejecutando type checking con MyPy..."
          mypy app/ --ignore-missing-imports --no-strict-optional || true
      
      - name: ðŸ“Š Pylint - AnÃ¡lisis profundo
        working-directory: backend
        run: |
          echo "ðŸ“Š Ejecutando Pylint..."
          pylint app/ --exit-zero --output-format=text --reports=y > pylint-report.txt || true
          cat pylint-report.txt | head -100
          echo "âœ… Pylint completado"
      
      - name: ðŸ“¤ Subir reportes Python
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: python-quality-reports
          path: |
            backend/flake8-report.txt
            backend/pylint-report.txt
          retention-days: 7

  # ===============================================
  # JavaScript/TypeScript Code Quality
  # ===============================================
  javascript-quality:
    name: âš›ï¸ JavaScript/TypeScript Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: ðŸ“¦ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: ðŸ“¦ Instalar dependencias
        working-directory: frontend
        run: npm ci
      
      - name: ðŸŽ¨ ESLint - AnÃ¡lisis de cÃ³digo
        working-directory: frontend
        run: |
          echo "ðŸŽ¨ Ejecutando ESLint..."
          npm run lint -- --format json --output-file eslint-report.json || true
          npm run lint || echo "âš ï¸ ESLint encontrÃ³ problemas"
      
      - name: ðŸ”¬ TypeScript - Type checking
        working-directory: frontend
        run: |
          echo "ðŸ”¬ Ejecutando TypeScript compiler..."
          npx tsc --noEmit --pretty || echo "âš ï¸ TypeScript encontrÃ³ errores de tipos"
      
      - name: ðŸ“Š Prettier - Verificar formato
        working-directory: frontend
        run: |
          echo "ðŸ“Š Verificando formato con Prettier..."
          npx prettier --check "**/*.{js,jsx,ts,tsx,json,css,md}" || echo "âš ï¸ Algunos archivos necesitan formato"
      
      - name: ðŸ“¤ Subir reportes JavaScript
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: javascript-quality-reports
          path: frontend/eslint-report.json
          retention-days: 7

  # ===============================================
  # Code Complexity Analysis
  # ===============================================
  complexity-analysis:
    name: ðŸ“ˆ Complexity Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: ðŸ Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: ðŸ“¦ Instalar radon
        run: pip install radon
      
      - name: ðŸ“ˆ AnÃ¡lisis de complejidad ciclomÃ¡tica
        working-directory: backend
        run: |
          echo "ðŸ“ˆ Analizando complejidad ciclomÃ¡tica..."
          radon cc app/ -a -s -j > complexity-report.json || true
          radon cc app/ -a -s || true
          echo "âœ… AnÃ¡lisis completado"
      
      - name: ðŸ“Š AnÃ¡lisis de mantenibilidad
        working-directory: backend
        run: |
          echo "ðŸ“Š Analizando Ã­ndice de mantenibilidad..."
          radon mi app/ -s -j > maintainability-report.json || true
          radon mi app/ -s || true
      
      - name: ðŸ“¤ Subir reportes de complejidad
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: complexity-reports
          path: |
            backend/complexity-report.json
            backend/maintainability-report.json
          retention-days: 7

  # ===============================================
  # Documentation Quality
  # ===============================================
  documentation-quality:
    name: ðŸ“š Documentation Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: ðŸ Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: ðŸ“¦ Instalar pydocstyle
        run: pip install pydocstyle
      
      - name: ðŸ“š Verificar docstrings Python
        working-directory: backend
        run: |
          echo "ðŸ“š Verificando docstrings con pydocstyle..."
          pydocstyle app/ --count || echo "âš ï¸ Algunos docstrings necesitan mejoras"
      
      - name: ðŸ“ Verificar README
        run: |
          echo "ðŸ“ Verificando existencia de documentaciÃ³n..."
          [ -f README.md ] && echo "âœ… README.md existe" || echo "âŒ README.md no encontrado"
          [ -f docs/API.md ] && echo "âœ… DocumentaciÃ³n API existe" || echo "âš ï¸ Considera agregar docs/API.md"

  # ===============================================
  # Code Duplication Detection
  # ===============================================
  duplication-detection:
    name: ðŸ”„ Duplicate Code Detection
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: ðŸ“¦ Instalar jscpd
        run: npm install -g jscpd
      
      - name: ðŸ”„ Detectar cÃ³digo duplicado
        run: |
          echo "ðŸ”„ Buscando cÃ³digo duplicado..."
          jscpd . \
            --ignore "**/__pycache__/**,**/node_modules/**,**/dist/**,**/build/**,**/.next/**" \
            --min-lines 5 \
            --min-tokens 50 \
            --format "json" \
            --output "./jscpd-report.json" || true
          
          jscpd . \
            --ignore "**/__pycache__/**,**/node_modules/**,**/dist/**,**/build/**,**/.next/**" \
            --min-lines 5 \
            --min-tokens 50 || true
      
      - name: ðŸ“¤ Subir reporte de duplicaciÃ³n
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: duplication-report
          path: jscpd-report.json
          retention-days: 7

  # ===============================================
  # Resumen de Calidad
  # ===============================================
  quality-summary:
    name: ðŸ“Š Quality Summary
    runs-on: ubuntu-latest
    needs: [python-quality, javascript-quality, complexity-analysis, documentation-quality, duplication-detection]
    if: always()
    
    steps:
      - name: ðŸ“Š Generar resumen
        run: |
          echo "## ðŸŽ¨ Resumen de Calidad de CÃ³digo" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… AnÃ¡lisis Completados:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### ðŸ Python:" >> $GITHUB_STEP_SUMMARY
          echo "- Flake8: AnÃ¡lisis de estilo" >> $GITHUB_STEP_SUMMARY
          echo "- Black: VerificaciÃ³n de formato" >> $GITHUB_STEP_SUMMARY
          echo "- isort: Orden de imports" >> $GITHUB_STEP_SUMMARY
          echo "- MyPy: Type checking" >> $GITHUB_STEP_SUMMARY
          echo "- Pylint: AnÃ¡lisis profundo" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### âš›ï¸ JavaScript/TypeScript:" >> $GITHUB_STEP_SUMMARY
          echo "- ESLint: AnÃ¡lisis de cÃ³digo" >> $GITHUB_STEP_SUMMARY
          echo "- TypeScript: Type checking" >> $GITHUB_STEP_SUMMARY
          echo "- Prettier: VerificaciÃ³n de formato" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### ðŸ“ˆ MÃ©tricas:" >> $GITHUB_STEP_SUMMARY
          echo "- Complejidad ciclomÃ¡tica" >> $GITHUB_STEP_SUMMARY
          echo "- Ãndice de mantenibilidad" >> $GITHUB_STEP_SUMMARY
          echo "- DetecciÃ³n de cÃ³digo duplicado" >> $GITHUB_STEP_SUMMARY
          echo "- Calidad de documentaciÃ³n" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ **Descarga los reportes detallados desde los Artifacts**" >> $GITHUB_STEP_SUMMARY
